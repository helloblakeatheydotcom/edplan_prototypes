<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Physician Authorization - Admin Dashboard</title>

  <!-- Roboto -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Lucide (icons) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --nav:#0B2E78;
      --navText:#ffffff;
      --navUnderline:#FBBF24;

      --bg:#ffffff;
      --page:#f6f7fb;

      --text:#333333;
      --muted:#6B7280;
      --line:#E5E7EB;

      --action:#2963ff;
      --actionHoverBg:#2963ff;
      --actionHoverText:#ffffff;

      --underline:#C7CDD6;
      --underlineFocus:#2963ff;

      /* Status tokens */
      --pendingText:#586874;
      --pendingFill:#F3F4F6;

      --panelRadius:2px;
      --btnRadius:2px;
      --max:1100px;
      --max:1320px;

      --indent:24px; /* indent inside Quick Filters */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--text);
      background:var(--page);
      font-size:13px; /* slight bump */
    }

    /* Top navigation (placeholder) */
    .topbar{
      background:var(--nav); color:var(--navText); border-bottom:1px solid rgba(255,255,255,.08);
      position:sticky;
      top:0;
      z-index:90;
    }
    .topbar-inner{
      max-width:calc(var(--max) + 28px);
      margin:0 auto;
      padding:0 14px;
      display:flex;
      align-items:center;
      gap:14px;
      height:48px;
    }
    .brand{ font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:10px; white-space:nowrap; }
    .brand-badge{ width:18px; height:18px; background:#fff; border-radius:3px; opacity:.9; }
    .nav{
      display:flex; align-items:center; gap:6px;
      flex:1; overflow:auto; scrollbar-width:none;
    }
    .nav::-webkit-scrollbar{ display:none; }
    .nav a{
      color:rgba(255,255,255,.92);
      text-decoration:none;
      font-size:12px;
      font-weight:700;
      padding:14px 10px 12px;
      text-transform:uppercase;
      letter-spacing:.25px;
      border-bottom:3px solid transparent;
      white-space:nowrap;
    }
    .nav a:hover{ color:#fff; background:rgba(255,255,255,.06); }
    .nav a.is-active{ color:#fff; border-bottom-color:var(--navUnderline); }

    .shell{ max-width:var(--max); margin:14px auto 28px; padding:0 14px; }
    .crumbs{ font-size:12px; color:var(--muted); padding:10px 2px 12px; }

    .panel{
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:var(--panelRadius);
      overflow:hidden;
    }

    /* Panel title row */
    .panel-titlebar{ padding:18px 18px 12px; }
    .header-row{ display:flex; align-items:flex-start; gap:12px; }
    .title{
      font-size:22px; /* slight bump */
      font-weight:700;
      line-height:1.25;
    }
    .header-actions{ margin-left:auto; display:flex; align-items:center; gap:10px; }

    /* Unified action button styling (Export/Apply/Advanced all identical) */
    .action-linkbtn{
      appearance:none;
      border:none;
      background:transparent;
      color:var(--action);
      font-size:14px;
      font-weight:700;
      text-transform:uppercase;
      min-width: 84px;
      padding:0 16px;
      border-radius:var(--btnRadius);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      line-height:36px; /* prevents “floaty” text differences */
      user-select:none;
      position: relative;
    }
    .action-linkbtn:hover{
      background:var(--actionHoverBg);
      color:var(--actionHoverText);
    }

    .panel-sep{ border-top:1px solid var(--line); }

    /* Instructions note */
    .instructions{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px 18px 14px;
      color:var(--muted);
      font-size:14px;
    }
    .info-dot{
      width:24px; height:24px;
      border-radius:999px;
      background:var(--action);
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
      font-size:14px;
      flex:0 0 auto;
    }

    .panel-body{ padding:0 18px 10px; }

    /* Quick Filters collapsible section header */
    .section-header{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 0;
      cursor:default;
      user-select:none;
    }
    .section-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:18px;  /* slight bump */
      font-weight:700;
      color:var(--text);
      cursor:pointer;
    }
    .chev{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:#6B7280;
    }
    .chev .lucide{ width:18px; height:18px; stroke-width:2; }
    .section-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .section-sep{ border-top:1px solid var(--line); }

    .section-content{ padding:12px 0 6px; }
    .is-collapsed .section-content{ display:none; }
    .is-collapsed .chev{ transform:rotate(-90deg); }

    /* Indented “inside section” content */
    .qf-inner{
      padding-left:var(--indent);
    }

    .active-filters{
      font-size:14px;
      color:var(--muted);
      margin:0 0 10px 0;
      padding-top:8px;
    }

    /* Underlined controls */
    .filters-row{
      display:flex;
      align-items:flex-end;
      gap:18px;
      flex-wrap:wrap;
      padding-top:4px;
      padding-bottom:6px;
    }
    .field{ min-width:170px; }
    .label{
      font-size:14px;
      color:var(--muted);
      font-weight:700;
      margin-bottom:6px;
    }
    .underline-select,
    .underline-input{
      width:100%;
      border:none;
      border-bottom:1px solid var(--underline);
      border-radius:0;
      padding:8px 22px 6px 0;
      font-size:12px;
      font-size:14px;
      font-family:Roboto, sans-serif;
      background:transparent;
      outline:none;
      color:var(--text);
    }
    .underline-select:focus,
    .underline-input:focus{
      border-bottom:2px solid var(--underlineFocus);
      padding-bottom:5px;
    }

    .select-wrap{ position:relative; }
    .select-wrap::after{
      content:"";
      position:absolute;
      right:2px;
      top:50%;
      width:7px; height:7px;
      border-right:2px solid #6B7280;
      border-bottom:2px solid #6B7280;
      transform:translateY(-55%) rotate(45deg);
      pointer-events:none;
      opacity:.9;
    }
    select.underline-select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
    }

    /* Custom Multi-select Dropdown */
    .multiselect-menu {
      position: absolute;
      top: 100%; left: 0; width: 100%;
      background: #fff;
      border: 1px solid var(--line);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 4px;
      padding: 8px;
      z-index: 50;
      display: flex; flex-direction: column; gap: 6px;
    }
    .multiselect-menu label { display:flex; align-items:center; gap:8px; font-size:13px; cursor:pointer; }

    /* Results toolbar (search) */
    .results-toolbar{
      display:flex;
      align-items:flex-end;
      gap:16px;
      margin-top:12px;
      margin-bottom:6px;
    }
    .results-toolbar .spacer{ flex:1; }
    .search{
      min-width:260px;
      display:flex;
      flex-direction:column;
      gap:0;        /* label closer */
      padding-bottom:6px;
    }
    .search label{
      font-size:12px;
      color:var(--muted);
      font-weight:500;
      margin:0;       /* pull closer */
      line-height:1.1;
    }
    .searchbox{ position:relative; }
    .searchbox .underline-input{ padding-right:24px; }
    .searchbox .icon{
      position:absolute;
      right:0;
      top:50%;
      transform:translateY(-45%);
      color:#6B7280;
    }

    /* Lucide global */
    .lucide{ width:16px; height:16px; stroke-width:2; }

    /* Table */
    .table-wrap{ overflow:auto; margin-top:6px; }
    table{ width:100%; border-collapse:collapse; font-size:12px; color:var(--text); }
    thead th{
      text-align:left;
      color:var(--muted);
      font-size:13px;
      font-weight:700;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
    }

    /* Status pills (alignment fix) */
    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:11px;
      white-space:nowrap;
      line-height:1;
    }
    .status-pill .lucide{
      width:16px;
      height:16px;
      stroke-width:2;
      display:block;
    }
    .pending{ color:var(--pendingText); background:var(--pendingFill); }
    .signed{ color:#127C49; background:#E6F4EA; }
    .denied{ color:#B91C1C; background:#FEE2E2; }
    .resubmitted{ color:#B45309; background:#FEF3C7; }
    .returned{ color:#6B21A8; background:#F3E8FF; }
    .superseded{ color:#334155; background:#E2E8F0; }

    /* Icon columns (eye / pencil) */
    .icon-col{ text-align:center; white-space:nowrap; width:1%; }
    .icon-btn{
      border:none;
      background:transparent;
      cursor:pointer;
      color:#4B5563;
      padding:4px;
      border-radius:8px;
    }
    .icon-btn:hover{ background:#F3F4F6; color:#111827; }
    .icon-btn .lucide{ width:18px; height:18px; stroke-width:2; }

    /* Footer */
    .table-footer{
      display:flex;
      align-items:center;
      gap:14px;
      padding:12px 2px 10px;
      color:var(--muted);
      font-size:12px;
    }
    .footer-left{ display:flex; align-items:center; gap:8px; }
    .pager{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pager button{
      padding:6px 10px;
      border:1px solid #D1D5DB;
      background:#fff;
      border-radius:8px;
      cursor:pointer;
      font-size:12px;
    }
    .pager button:disabled{ opacity:.5; cursor:not-allowed; }
    .page-box{
      width:34px;
      height:28px;
      border:1px solid #D1D5DB;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#fff;
      font-weight:700;
      color:#374151;
    }

    /* Modal */
    .modal-overlay{
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      z-index:100;
      display:flex; align-items:center; justify-content:center;
    }
    .modal-content{
      background:#fff;
      width:700px;
      max-width:90%;
      border-radius:4px;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);
      display:flex; flex-direction:column;
    }
    .modal-header{
      padding:16px 20px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
    }
    .modal-title{ font-size:18px; font-weight:700; }
    .close-btn{ background:none; border:none; font-size:24px; cursor:pointer; color:var(--muted); line-height:1; }
    .modal-body{ padding:20px; }
    .modal-footer{
      padding:16px 20px;
      border-top:1px solid var(--line);
      display:flex; justify-content:flex-end; gap:10px;
      background:#f9fafb;
      border-radius:0 0 4px 4px;
    }
    .modal-subtitle{ font-size:16px; font-weight:700; margin-bottom:12px; color:var(--text); }
    .form-group{ margin-bottom:16px; }
    .radio-group{ display:flex; gap:20px; margin-top:8px; }
    .radio-group label{ display:flex; align-items:center; gap:6px; cursor:pointer; font-size:14px; }
    .checkbox-label{ display:flex; align-items:center; gap:8px; font-size:14px; cursor:pointer; }
    .signature-pad{ height:100px; border:1px dashed #9CA3AF; background:#F9FAFB; display:flex; align-items:center; justify-content:center; color:#9CA3AF; border-radius:4px; margin-top:6px; }
    .btn-cancel{ padding:8px 16px; border:none; background:#127C49; color:#fff; border-radius:4px; cursor:pointer; font-weight:700; text-transform:uppercase; }
    .btn-cancel:hover{ background:#0e6239; }
    .btn-primary{ padding:8px 16px; border:none; background:#127C49; color:#fff; border-radius:4px; cursor:pointer; font-weight:700; text-transform:uppercase; }
    .btn-primary:hover{ background:#0e6239; }

    /* Modal Student Info */
    .modal-student-info { background: #F9FAFB; border: 1px solid var(--line); border-radius: 4px; padding: 12px; margin-bottom: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px 24px; font-size: 13px; }
    .info-row { display: flex; flex-direction: column; gap: 2px; }
    .info-label { font-weight: 700; color: var(--muted); font-size: 11px; text-transform: uppercase; }
    .info-value { font-weight: 500; color: var(--text); }

    .services-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px; }
    .services-table th { text-align: left; background: #F3F4F6; padding: 8px 10px; border: 1px solid var(--line); font-weight: 700; color: var(--muted); font-size:11px; text-transform:uppercase; }
    .services-table td { padding: 8px 10px; border: 1px solid var(--line); vertical-align:top; }
    .services-table td:last-child { white-space:nowrap; }
    .svc-name{ font-weight:700; color:var(--nav); }

    @media (max-width: 900px){
      .section-actions{ width:100%; margin-left:0; justify-content:flex-end; }
      .search{ min-width:220px; }
    }
    @media (max-width: 640px){
      .header-row{ flex-direction:column; }
      .header-actions{ margin-left:0; }
      .section-header{ flex-wrap:wrap; }
      .results-toolbar{ flex-direction:column; align-items:stretch; }
      .search{ min-width:unset; width:100%; }
      .field{ min-width:140px; flex:1; }
      .qf-inner{ padding-left:16px; }
    }
  </style>
</head>

<body>
  <header class="topbar" role="banner">
    <div class="topbar-inner">
      <div class="brand">
        <span class="brand-badge" aria-hidden="true"></span>
        edplan
      </div>

      <nav class="nav" aria-label="Primary navigation">
        <a href="#" onclick="return false;">Main Menu</a>
        <a href="#" onclick="return false;">My Account</a>
        <a href="#" onclick="return false;">Wizards</a>
        <a href="#" onclick="return false;">Students</a>
        <a href="#" onclick="return false;">Parents</a>
        <a class="is-active" href="#" onclick="return false;">Physician Authorization</a>
        <a href="#" onclick="return false;">Students</a>
        <a href="#" onclick="return false;">Tools</a>
        <a href="#" onclick="return false;">Reports</a>
        <a href="#" onclick="return false;">Admin/System</a>
        <a href="#" onclick="return false;">Log Off</a>
        <a href="PhysAuth_Physician_Dashboard.html" style="color:#FBBF24;">Switch to Physician</a>
      </nav>
    </div>
  </header>

  <div class="shell">
    <div class="crumbs">HOME / PHYS AUTH ADMIN</div>

    <section class="panel" aria-label="Physician Authorization - Admin Dashboard">
      <div class="panel-titlebar">
        <div class="header-row">
          <div class="title">Physician Authorization - Admin Dashboard</div>
          <div class="header-actions">
            <!-- Use button to avoid anchor default styling differences -->
            <button class="action-linkbtn" type="button" onclick="alert('Export results')">EXPORT RESULTS</button>
          </div>
        </div>
      </div>

      <div class="panel-sep" aria-hidden="true"></div>

      <div class="instructions" role="note" aria-label="Instructions">
        <div class="info-dot">i</div>
        <div>Please review the following IEPs that are <strong>Pending</strong> and provide physician authorization.</div>
      </div>

      <div class="panel-body">
        <div id="quickFilters" class="qf is-expanded">
          <div class="section-header">
            <div class="section-title" role="button" tabindex="0" aria-expanded="true" aria-controls="quickFiltersContent">
              <span class="chev" aria-hidden="true"><i data-lucide="chevron-down"></i></span>
              Quick Filters
            </div>

            <div class="section-actions">
              <button class="action-linkbtn" type="button" onclick="applyFilters()">APPLY FILTERS</button>
              <button class="action-linkbtn" type="button" onclick="clearFilters()">CLEAR FILTERS</button>
              <button class="action-linkbtn" type="button" onclick="alert('Advanced filters')">ADVANCED FILTERS</button>
            </div>
          </div>

          <div class="section-sep" aria-hidden="true"></div>

          <div id="quickFiltersContent" class="section-content">
            <div class="qf-inner">
              <div class="active-filters">
                Active Filters: <strong>Custom IEP Date Range</strong>: 01/01/20XX-12/31/20XX
              </div>

              <div class="filters-row" aria-label="Quick Filters fields">
                <div class="field">
                  <div class="label">IEP Type</div>
                  <div class="select-wrap">
                    <select id="filterType" class="underline-select" aria-label="IEP Type">
                      <option value="">All Types</option>
                      <option>Annual</option>
                      <option>Initial</option>
                      <option>Revision</option>
                    </select>
                  </div>
                </div>

                <div class="field">
                  <div class="label">IEP Services</div>
                  <div class="select-wrap" style="position:relative;">
                    <button type="button" id="serviceDropdownBtn" class="underline-select" style="text-align:left; cursor:pointer;" onclick="toggleServiceMenu()">All Services</button>
                    <div id="serviceMenu" class="multiselect-menu" style="display:none;">
                      <label><input type="checkbox" value="OT" onchange="updateServiceLabel()"> OT</label>
                      <label><input type="checkbox" value="PT" onchange="updateServiceLabel()"> PT</label>
                      <label><input type="checkbox" value="Speech" onchange="updateServiceLabel()"> Speech</label>
                      <label><input type="checkbox" value="Counseling" onchange="updateServiceLabel()"> Counseling</label>
                    </div>
                  </div>
                </div>

                <div class="field">
                  <div class="label">Status</div>
                  <div class="select-wrap">
                    <select id="filterStatus" class="underline-select" aria-label="Status">
                      <option value="">All Statuses</option>
                      <option>Pending</option>
                      <option>Signed</option>
                      <option>Denied</option>
                    </select>
                  </div>
                </div>

                <div class="field">
                  <div class="label">IEP Date Range</div>
                  <div class="select-wrap">
                    <select id="filterDateRange" class="underline-select" aria-label="IEP Date Range">
                      <option value="">All Ranges</option>
                      <option>Last 30 Days</option>
                      <option>Last 60 Days</option>
                      <option>Custom Range</option>
                    </select>
                  </div>
                </div>

                <div class="field">
                  <div class="label">School Year</div>
                  <div class="select-wrap">
                    <select id="filterYear" class="underline-select" aria-label="School Year">
                      <option value="">All Years</option>
                      <option>2024–2025</option>
                      <option>2023–2024</option>
                      <option>2022–2023</option>
                    </select>
                  </div>
                </div>
              </div>
            </div><!-- /qf-inner -->
          </div>
        </div>

        <div class="results-toolbar">
          <div class="spacer"></div>

          <div class="search">
            <label for="searchInput">Search:</label>
            <div class="searchbox">
              <input id="searchInput" class="underline-input" type="text" oninput="applyFilters()" />
              <span class="icon" aria-hidden="true"><i data-lucide="search"></i></span>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table id="resultsTable" aria-label="Results table">
            <thead>
              <tr>
                <th>Status</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Student ID</th>
                <th>Medicaid ID</th>
                <th>Event ID</th>
                <th>IEP Type</th>
                <th>IEP Date Range</th>
                <th>IEP Services</th>
                <th class="icon-col">Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- Rows rendered via JS -->
            </tbody>
          </table>
        </div>

        <div class="table-footer">
          <div class="footer-left">
            <span>Show</span>
            <div class="select-wrap" style="width:70px;">
              <select class="underline-select" aria-label="Entries per page">
                <option selected>10</option>
                <option>25</option>
                <option>50</option>
              </select>
            </div>
            <span>entries</span>
          </div>

          <div class="pager">
            <button id="btnPrev" onclick="changePage(-1)" disabled>Previous</button>
            <div id="pageDisplay" class="page-box">1</div>
            <button id="btnNext" onclick="changePage(1)">Next</button>
          </div>
        </div>

        <div style="padding:0 2px 10px; color:var(--muted); font-size:12px;">
          Showing <strong id="showStart">0</strong> to <strong id="showEnd">0</strong> of <strong id="showTotal">0</strong> entries
        </div>
      </div>
    </section>
  </div>

  <!-- Respond Modal -->
  <div id="respondModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Manage Authorization Request</div>
        <button type="button" class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-student-info">
          <div class="info-row"><div class="info-label">Student Name</div><div class="info-value" id="mName">--</div></div>
          <div class="info-row"><div class="info-label">Student ID</div><div class="info-value" id="mID">--</div></div>
          <div class="info-row"><div class="info-label">IEP Date Range</div><div class="info-value" id="mDate">--</div></div>
          <div class="info-row"><div class="info-label">Has Medicaid Consent</div><div class="info-value" id="mConsent">--</div></div>
        </div>

        <div class="form-group">
          <div class="label">Select Action</div>
          <div class="radio-group" style="flex-direction:column; align-items:flex-start; gap:12px;">
            <label>
              <input type="radio" name="adminAction" value="resubmit" onchange="toggleAdminAction(this.value)">
              Resubmit authorization request to Authorizing Physician
            </label>
            <div id="descResubmit" style="display:none; margin-left:24px; width:calc(100% - 24px); padding:8px 12px; background:#EFF6FF; color:#1E40AF; border-radius:4px; font-size:13px; line-height:1.4;">
              Resubmitting this record will reset the status of this request from Denied to Resubmitted.
            </div>

            <label>
              <input type="radio" name="adminAction" value="return" onchange="toggleAdminAction(this.value)">
              Return student record to SPED Teacher
            </label>
            <div id="descReturn" style="display:none; margin-left:24px; width:calc(100% - 24px);">
              <div style="padding:8px 12px; background:#FFF7ED; color:#9A3412; border-radius:4px; font-size:13px; line-height:1.4; margin-bottom:10px;">
                Returning this record to the SPED Teacher will trigger a message board alert and include the Return Notes entered below.
              </div>
              <div class="form-group">
                <div class="label">Return Notes <span style="color:#B91C1C">*</span></div>
                <textarea id="returnNotes" style="width:100%; height:80px; padding:8px; border:1px solid var(--line); border-radius:4px; font-family:inherit; font-size:13px; resize:vertical;"></textarea>
                <div id="returnNotesError" style="display:none; color:#B91C1C; font-size:12px; margin-top:4px;">This field is required.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
        <button id="btnAction" type="button" class="btn-primary" onclick="confirmAdminAction()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- View Details Modal -->
  <div id="detailsModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Authorization Details</div>
        <button type="button" class="close-btn" onclick="closeDetailsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-student-info">
          <div class="info-row"><div class="info-label">Student Name</div><div class="info-value" id="dName">--</div></div>
          <div class="info-row"><div class="info-label">Student ID</div><div class="info-value" id="dID">--</div></div>
          <div class="info-row"><div class="info-label">IEP Date Range</div><div class="info-value" id="dDate">--</div></div>
          <div class="info-row"><div class="info-label">IEP Document</div><div class="info-value"><a href="#" onclick="return false;" style="color:var(--action); text-decoration:none; font-weight:700;">View Document</a></div></div>
        </div>

        <div class="modal-subtitle">IEP Services</div>
        <table class="services-table">
          <thead>
            <tr>
              <th>Service</th>
              <th>Duration / Frequency</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody id="dServicesBody"></tbody>
        </table>

        <div class="section-sep" style="margin:20px 0;"></div>
        <div class="modal-subtitle">Physician Response</div>
        
        <div class="modal-student-info" style="grid-template-columns: 1fr 1fr 1fr;">
          <div class="info-row"><div class="info-label">Status</div><div class="info-value" id="dStatus">--</div></div>
          <div class="info-row"><div class="info-label">Response Date</div><div class="info-value" id="dResponseDate">--</div></div>
          <div class="info-row" id="dReasonRow"><div class="info-label">Denial Reason</div><div class="info-value" id="dReason">--</div></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-cancel" onclick="closeDetailsModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    if (typeof lucide !== 'undefined') {
      lucide.createIcons({ attrs: { fill: "none", stroke: "currentColor" } });
    }

    // --- Data Simulation ---
    let allStudents = [
      { first: "James", last: "Thomas", id: "123456", type: "Annual", services: "OT, PT, Speech", year: "2022–2023", dateRange: "08/15/2022–08/14/2023", medicaid: "Yes" },
      { first: "Jane", last: "Doe", id: "984094", type: "Annual", services: "OT, PT", year: "2022–2023", dateRange: "09/01/2022–08/31/2023", medicaid: "No" },
      { first: "Irene", last: "Smith", id: "552011", type: "Initial", services: "PT", year: "2023–2024", dateRange: "08/20/2023–08/18/2024", medicaid: "Yes" },
      { first: "Marcus", last: "Nguyen", id: "778210", type: "Revision", services: "OT", year: "2023–2024", dateRange: "10/01/2023–09/29/2024", medicaid: "N/A" },
      { first: "Sophia", last: "Patel", id: "113020", type: "Annual", services: "Speech", year: "2024–2025", dateRange: "08/10/2024–08/09/2025", medicaid: "Yes" },
      { first: "Michael", last: "Brown", id: "224132", type: "Initial", services: "Counseling", year: "2024–2025", dateRange: "01/05/2025–01/04/2026", medicaid: "No" },
      { first: "Emily", last: "Davis", id: "335243", type: "Annual", services: "OT, Speech", year: "2023–2024", dateRange: "08/15/2023–08/13/2024", medicaid: "Yes" },
      { first: "William", last: "Wilson", id: "446354", type: "Revision", services: "PT, Counseling", year: "2022–2023", dateRange: "11/01/2022–10/31/2023", medicaid: "Yes" },
      { first: "Olivia", last: "Martinez", id: "557465", type: "Annual", services: "Speech", year: "2024–2025", dateRange: "09/15/2024–09/14/2025", medicaid: "N/A" },
      { first: "Alexander", last: "Anderson", id: "668576", type: "Initial", services: "OT", year: "2023–2024", dateRange: "02/01/2024–01/30/2025", medicaid: "Yes" },
      { first: "Emma", last: "Taylor", id: "779687", type: "Annual", services: "PT", year: "2022–2023", dateRange: "08/22/2022–08/21/2023", medicaid: "No" },
      { first: "Daniel", last: "Thomas", id: "880798", type: "Revision", services: "Counseling", year: "2024–2025", dateRange: "10/10/2024–10/09/2025", medicaid: "Yes" },
      { first: "Ava", last: "Hernandez", id: "991809", type: "Annual", services: "OT, PT", year: "2023–2024", dateRange: "08/05/2023–08/03/2024", medicaid: "Yes" },
      { first: "Noah", last: "Moore", id: "102910", type: "Initial", services: "Speech", year: "2022–2023", dateRange: "03/01/2023–02/28/2024", medicaid: "N/A" },
      { first: "Isabella", last: "Martin", id: "213021", type: "Annual", services: "OT", year: "2024–2025", dateRange: "08/18/2024–08/17/2025", medicaid: "Yes" },
      { first: "Liam", last: "Jackson", id: "324132", type: "Revision", services: "PT, Speech", year: "2023–2024", dateRange: "12/01/2023–11/29/2024", medicaid: "No" },
      { first: "Mia", last: "Thompson", id: "435243", type: "Annual", services: "Counseling", year: "2022–2023", dateRange: "09/05/2022–09/04/2023", medicaid: "Yes" },
      { first: "Lucas", last: "White", id: "546354", type: "Initial", services: "OT, PT", year: "2024–2025", dateRange: "08/30/2024–08/29/2025", medicaid: "Yes" },
      { first: "Charlotte", last: "Lopez", id: "657465", type: "Annual", services: "Speech", year: "2023–2024", dateRange: "08/12/2023–08/10/2024", medicaid: "N/A" },
      { first: "Mason", last: "Lee", id: "768576", type: "Revision", services: "PT", year: "2022–2023", dateRange: "01/15/2023–01/14/2024", medicaid: "Yes" },
      { first: "Amelia", last: "Gonzalez", id: "879687", type: "Annual", services: "OT", year: "2024–2025", dateRange: "09/20/2024–09/19/2025", medicaid: "No" },
      { first: "Logan", last: "Harris", id: "980798", type: "Initial", services: "Counseling", year: "2023–2024", dateRange: "11/15/2023–11/13/2024", medicaid: "Yes" },
      { first: "Harper", last: "Clark", id: "091809", type: "Annual", services: "OT, Speech", year: "2022–2023", dateRange: "08/08/2022–08/07/2023", medicaid: "Yes" },
      { first: "Elijah", last: "Lewis", id: "112910", type: "Revision", services: "PT", year: "2024–2025", dateRange: "10/25/2024–10/24/2025", medicaid: "N/A" },
      { first: "Evelyn", last: "Robinson", id: "223021", type: "Annual", services: "Speech", year: "2023–2024", dateRange: "08/25/2023–08/23/2024", medicaid: "Yes" },
      { first: "Aiden", last: "Walker", id: "334132", type: "Initial", services: "OT, PT", year: "2022–2023", dateRange: "04/01/2023–03/30/2024", medicaid: "Yes" },
      { first: "Abigail", last: "Perez", id: "445243", type: "Annual", services: "Counseling", year: "2024–2025", dateRange: "08/14/2024–08/13/2025", medicaid: "No" }
    ];

    // --- Local Storage Logic ---
    const STORAGE_KEY = 'edplan_physauth_data';
    const storedData = localStorage.getItem(STORAGE_KEY);

    if (storedData) {
      allStudents = JSON.parse(storedData);
      // Ensure Admin specific fields exist if data came from Physician view
      let dirty = false;
      allStudents.forEach(s => {
        if (!s.medicaidId) { s.medicaidId = "M" + Math.floor(10000000 + Math.random() * 90000000); dirty = true; }
        if (!s.eventId) { s.eventId = Math.floor(100000 + Math.random() * 900000); dirty = true; }
      });
      if (dirty) localStorage.setItem(STORAGE_KEY, JSON.stringify(allStudents));
    } else {
      // Initialize status if fresh
      const statuses = ["Pending", "Signed", "Denied", "Resubmitted", "Returned", "Superseded"];
      const denialReasons = ["Frequency/Duration Concerns", "Medical Necessity Not Established", "Incomplete Documentation"];

      allStudents.forEach(s => {
        s.status = statuses[Math.floor(Math.random() * statuses.length)];
        s.medicaidId = "M" + Math.floor(10000000 + Math.random() * 90000000);
        s.eventId = Math.floor(100000 + Math.random() * 900000);

        if (s.status !== "Pending") {
          const date = new Date();
          date.setDate(date.getDate() - Math.floor(Math.random() * 30));
          s.responseDate = date.toLocaleDateString();
        }
        if (s.status === "Denied") {
          s.denialReason = denialReasons[Math.floor(Math.random() * denialReasons.length)];
        }
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allStudents));
    }

    let currentData = [...allStudents];
    let currentStudentId = null;
    sortStudents(currentData);
    const pageSize = 10;
    let currentPage = 1;

    function sortStudents(data) {
      const statusRank = { "Pending": 1, "Resubmitted": 2, "Returned": 3, "Signed": 4, "Denied": 5 };
      data.sort((a, b) => {
        const rA = statusRank[a.status] || 99;
        const rB = statusRank[b.status] || 99;
        if (rA !== rB) return rA - rB;
        
        // Date sort (ascending start date)
        const dateA = new Date(a.dateRange.split('–')[0]);
        const dateB = new Date(b.dateRange.split('–')[0]);
        return dateA - dateB;
      });
    }

    function applyFilters() {
      const fStatus = document.getElementById('filterStatus').value;
      const fType = document.getElementById('filterType').value;
      const fServiceOptions = Array.from(document.querySelectorAll('#serviceMenu input:checked')).map(cb => cb.value);
      const fDateRange = document.getElementById('filterDateRange').value;
      const fYear = document.getElementById('filterYear').value;
      const fSearch = document.getElementById('searchInput').value.toLowerCase().trim();

      currentData = allStudents.filter(s => {
        // Dropdown filters
        if (fStatus && s.status !== fStatus) return false;
        if (fType && s.type !== fType) return false;
        if (fServiceOptions.length > 0 && !fServiceOptions.some(svc => s.services.includes(svc))) return false;
        if (fYear && s.year !== fYear) return false;

        // Text search (First, Last, ID)
        if (fSearch) {
          const fullText = `${s.first} ${s.last} ${s.id}`.toLowerCase();
          if (!fullText.includes(fSearch)) return false;
        }
        return true;
      });

      sortStudents(currentData);
      currentPage = 1;
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = currentData.slice(start, end);

      pageData.forEach(s => {
        const tr = document.createElement('tr');
        let statusClass = 'pending';
        let statusIcon = 'clock';
        if (s.status === 'Signed') { statusClass = 'signed'; statusIcon = 'check-circle'; }
        else if (s.status === 'Denied') { statusClass = 'denied'; statusIcon = 'ban'; }
        else if (s.status === 'Resubmitted') { statusClass = 'resubmitted'; statusIcon = 'rotate-cw'; }
        else if (s.status === 'Returned') { statusClass = 'returned'; statusIcon = 'corner-up-left'; }
        else if (s.status === 'Superseded') { statusClass = 'superseded'; statusIcon = 'file-stack'; }

        tr.innerHTML = `
          <td><span class="status-pill ${statusClass}"><i data-lucide="${statusIcon}"></i>${s.status}</span></td>
          <td>${s.first}</td>
          <td>${s.last}</td>
          <td>${s.id}</td>
          <td>${s.medicaidId}</td>
          <td>${s.eventId}</td>
          <td>${s.type}</td>
          <td>${s.dateRange}</td>
          <td>${s.services}</td>
          <td class="icon-col">
            <button class="icon-btn" type="button" title="View IEP"><i data-lucide="eye"></i></button>
            <button class="icon-btn" type="button" title="View Details" onclick="openDetailsModal('${s.id}')"><i data-lucide="file-text"></i></button>
            <button class="icon-btn" type="button" title="Actions" onclick="openModal('${s.id}')"><i data-lucide="pencil"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Update footer counts
      document.getElementById('showStart').textContent = currentData.length > 0 ? start + 1 : 0;
      document.getElementById('showEnd').textContent = Math.min(end, currentData.length);
      document.getElementById('showTotal').textContent = currentData.length;

      // Update pagination state
      const maxPage = Math.ceil(currentData.length / pageSize) || 1;
      document.getElementById('pageDisplay').textContent = currentPage;
      document.getElementById('btnPrev').disabled = currentPage === 1;
      document.getElementById('btnNext').disabled = currentPage >= maxPage;

      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    // Initial Render
    renderTable();

    // Expand/collapse Quick Filters
    (function(){
      const root = document.getElementById("quickFilters");
      const title = root.querySelector(".section-title");
      const content = document.getElementById("quickFiltersContent");

      function setExpanded(expanded){
        title.setAttribute("aria-expanded", String(expanded));
        if(expanded){
          root.classList.remove("is-collapsed");
          content.style.display = "";
        }else{
          root.classList.add("is-collapsed");
          content.style.display = "none";
        }
      }

      setExpanded(true);

      title.addEventListener("click", () => {
        const expanded = title.getAttribute("aria-expanded") === "true";
        setExpanded(!expanded);
      });

      title.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          const expanded = title.getAttribute("aria-expanded") === "true";
          setExpanded(!expanded);
        }
      });
    })();

    function changePage(delta) {
      const maxPage = Math.ceil(currentData.length / pageSize) || 1;
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= maxPage) {
        currentPage = newPage;
        renderTable();
      }
    }

    function clearFilters() {
      document.getElementById('filterStatus').value = "";
      document.getElementById('filterType').value = "";
      const checkboxes = document.querySelectorAll('#serviceMenu input');
      checkboxes.forEach(cb => cb.checked = false);
      updateServiceLabel();
      document.getElementById('filterDateRange').value = "";
      document.getElementById('filterYear').value = "";
      document.getElementById('searchInput').value = "";
      applyFilters();
    }

    // Multi-select dropdown logic
    function toggleServiceMenu() {
      const menu = document.getElementById('serviceMenu');
      menu.style.display = menu.style.display === 'none' ? 'flex' : 'none';
    }

    function updateServiceLabel() {
      const checked = document.querySelectorAll('#serviceMenu input:checked');
      const btn = document.getElementById('serviceDropdownBtn');
      if (checked.length === 0) btn.textContent = "All Services";
      else if (checked.length === 1) btn.textContent = checked[0].value;
      else btn.textContent = `${checked.length} Selected`;
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const wrap = document.getElementById('serviceDropdownBtn').parentNode;
      if (!wrap.contains(e.target)) {
        document.getElementById('serviceMenu').style.display = 'none';
      }
    });

    // Details Modal Logic
    function openDetailsModal(id) {
      const s = allStudents.find(st => st.id === id);
      if(!s) return;

      // Populate Student Info
      document.getElementById('dName').textContent = `${s.first} ${s.last}`;
      document.getElementById('dID').textContent = s.id;
      document.getElementById('dDate').textContent = s.dateRange;

      // Populate Services
      const tbody = document.getElementById('dServicesBody');
      tbody.innerHTML = '';
      const servicesList = s.services.split(', ');
      const fullNames = {
        "OT": "Occupational Therapy",
        "PT": "Physical Therapy",
        "Speech": "Speech-Language Pathology",
        "Counseling": "Counseling Services"
      };

      servicesList.forEach(svc => {
        const fullName = fullNames[svc] || svc;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div class="svc-name">${fullName}</div></td>
          <td>30 min / Weekly</td>
          <td>Special Education Setting</td>
        `;
        tbody.appendChild(tr);
      });

      // Populate Response
      document.getElementById('dStatus').textContent = s.status;
      document.getElementById('dResponseDate').textContent = s.responseDate || "--";
      document.getElementById('dReason').textContent = s.denialReason || "--";
      document.getElementById('dReasonRow').style.visibility = (s.status === 'Denied') ? 'visible' : 'hidden';

      document.getElementById('detailsModal').style.display = 'flex';
    }

    function closeDetailsModal() { document.getElementById('detailsModal').style.display = 'none'; }

    // Modal Logic
    function openModal(id){
      currentStudentId = id;
      const s = allStudents.find(st => st.id === id);
      if(!s) return;

      // Populate Student Info
      document.getElementById('mName').textContent = `${s.first} ${s.last}`;
      document.getElementById('mID').textContent = s.id;
      document.getElementById('mDate').textContent = s.dateRange;
      document.getElementById('mConsent').textContent = s.medicaid;

      document.getElementById('respondModal').style.display = 'flex';
      
      // Reset Admin Action Form
      const radios = document.getElementsByName('adminAction');
      radios.forEach(r => r.checked = false);
      document.getElementById('descResubmit').style.display = 'none';
      document.getElementById('descReturn').style.display = 'none';
      document.getElementById('returnNotes').value = '';
      document.getElementById('returnNotesError').style.display = 'none';
    }
    function closeModal(){ document.getElementById('respondModal').style.display = 'none'; }
    
    function toggleAdminAction(val){
      document.getElementById('descResubmit').style.display = (val === 'resubmit') ? 'block' : 'none';
      document.getElementById('descReturn').style.display = (val === 'return') ? 'block' : 'none';
    }

    function confirmAdminAction() {
      const action = document.querySelector('input[name="adminAction"]:checked')?.value;
      if (!action) return;

      if (action === 'return') {
        const notes = document.getElementById('returnNotes').value.trim();
        if (!notes) {
          document.getElementById('returnNotesError').style.display = 'block';
          return;
        }
        document.getElementById('returnNotesError').style.display = 'none';
      }

      closeModal();
      const s = allStudents.find(st => st.id === currentStudentId);
      if (s) {
        if (action === 'resubmit') {
          s.status = 'Resubmitted';
        } else {
          s.status = 'Returned';
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(allStudents));
        sortStudents(currentData);
        renderTable();
      }
    }
  </script>
</body>
</html>